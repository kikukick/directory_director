<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>マルチメディア対応ディレクトリツール</title>
  <style>
    :root {
      --bg-color: #1c1c1e;
      --root-color: #2c2c2e;
      --folder-color: #3a3a3c;
      --file-color: #4a4a4c;
      --accent: #0af;
      --font: 'Segoe UI','Helvetica Neue',sans-serif;
      --radius: 8px;
      --border: #333;
      --border-width: 2px;
      --btn-bg: #2a2a2a;
      --btn-border: #444;
      --btn-color: #ccc;
      --btn-hover-bg: #3a3a3a;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font);
      background: var(--bg-color);
      color: #f0f0f0;
      height: 100vh;
      display: flex;
      overflow: hidden;
      user-select: none;
    }
    body::before {
      content: "";
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(120deg,#1e1e1e,#2b2b2b,#1e1e1e);
      background-size:400% 400%;
      animation: grad 15s ease infinite;
      z-index:-1;
    }
    @keyframes grad {
      0% {background-position:0% 50%;}
      50% {background-position:100% 50%;}
      100% {background-position:0% 50%;}
    }
    .panel { display: flex; flex-direction: column; height:100%; }
    .left-panel {
      width:50%; min-width:200px;
      padding:1.5rem; overflow-y:auto;
      border-right:var(--border-width) solid var(--border);
    }
    .right-panel {
      width:50%; min-width:200px;
      padding:1.5rem; background:#222;
      display:flex; flex-direction:column;
    }
    #dragbar {
      width:5px; cursor:col-resize; background:var(--border);
    }
    #template-panel {
      display:flex; align-items:center; margin-bottom:1rem;
    }
    #template-select {
      flex-grow:1;
      background:#111; color:#f0f0f0;
      border:var(--border-width) solid #444; border-radius:var(--radius);
      padding:.5em; font-family:monospace;
    }
    #add-template-btn {
      background:var(--btn-bg); border:1px solid var(--btn-border);
      color:var(--btn-color); border-radius:var(--radius);
      padding:.6em 1em; font-size:1em; cursor:pointer;
      margin-left:.5rem; user-select:none;
    }
    #add-template-btn:hover { background:var(--btn-hover-bg); }
    #tree { list-style:none; flex-grow:1; margin-bottom:1rem; }
    .node {
      margin:.4em 0; padding:.6em 1em;
      border:var(--border-width) solid var(--border);
      border-radius:var(--radius);
      background:var(--file-color);
      display:flex; align-items:center;
      cursor:pointer;
    }
    .node.folder { background:var(--folder-color); }
    .node.root { background:var(--root-color); font-weight:bold; }
    .node.selected-folder { box-shadow:0 0 0 2px var(--accent); }
    .name {
      flex-grow:1; background:transparent;
      border:none; color:inherit;
    }
    .name:focus { outline:2px solid var(--accent); }
    .controls button {
      background:none; border:none; font-size:1.1em;
      color:var(--btn-color); cursor:pointer; margin-left:.3em;
    }
    .controls button:hover { color:var(--accent); }
    button {
      background:var(--btn-bg); border:1px solid var(--btn-border);
      color:var(--btn-color); border-radius:var(--radius);
      padding:.6em 1.5em; font-size:1em; cursor:pointer;
      margin:0.3rem 0; user-select:none;
    }
    button:hover { background:var(--btn-hover-bg); }
    input[type="file"] { display:none; }
    .children { list-style:none; padding-left:1.5em; }
    #editor-container { flex-grow:1; display:flex; flex-direction:column; }
    #filename-input {
      background:#111; color:#f0f0f0;
      border:var(--border-width) solid #444; border-radius:var(--radius);
      padding:.5em; font-family:monospace; margin-bottom:.5rem;
    }
    #extension-label {
      margin-left:.5em; color:#888;
      font-family:monospace;
    }
    textarea#editor {
      flex-grow:1; resize:both; background:#111;
      color:#f0f0f0; border:var(--border-width) solid #444;
      border-radius:var(--radius); padding:1rem;
      font-family:monospace; margin-bottom:.5rem;
    }
    canvas#waveform {
      width:100%; height:80px; margin-bottom:.5rem;
      background:#111; border:var(--border-width) solid #444;
      border-radius:var(--radius);
    }
    audio, video, img {
      max-width:100%; border:var(--border-width) solid #444;
      border-radius:var(--radius); margin-bottom:.5rem;
    }
  </style>
</head>
<body>
  <div class="panel left-panel" id="leftPanel">
    <div id="template-panel">
      <select id="template-select">
        <option value="">テンプレート選択...</option>
      </select>
      <button id="add-template-btn">テンプレート追加</button>
    </div>
    <ul id="tree"></ul>
    <button id="import-btn">ファイルをインポート</button>
    <button id="download-btn">ZIP ダウンロード</button>
    <input type="file" id="file-input" multiple />
  </div>
  <div id="dragbar"></div>
  <div class="panel right-panel" id="rightPanel">
    <div id="editor-container">
      <div style="display:flex; align-items:center; margin-bottom:.5rem;">
        <input type="text" id="filename-input" placeholder="選択中のファイル名" disabled />
        <span id="extension-label"></span>
      </div>
      <canvas id="waveform" style="display:none;"></canvas>
      <audio id="audio-player" controls style="display:none;"></audio>
      <video id="video-player" controls style="display:none; max-height:300px;"></video>
      <img id="image-viewer" style="display:none;" />
      <textarea id="editor" placeholder="編集可能なテキストエリア" disabled></textarea>
      <button id="save-btn" disabled>保存</button>
    </div>
  </div>

  <script src="templates.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
  <script>
    const tree = document.getElementById('tree');
    const importBtn = document.getElementById('import-btn');
    const downloadBtn = document.getElementById('download-btn');
    const fileInput = document.getElementById('file-input');
    const filenameInput = document.getElementById('filename-input');
    const extensionLabel = document.getElementById('extension-label');
    const editor = document.getElementById('editor');
    const saveBtn = document.getElementById('save-btn');
    const leftPanel = document.getElementById('leftPanel');
    const rightPanel = document.getElementById('rightPanel');
    const dragbar = document.getElementById('dragbar');
    const waveformCanvas = document.getElementById('waveform');
    const audioPlayer = document.getElementById('audio-player');
    const videoPlayer = document.getElementById('video-player');
    const imageViewer = document.getElementById('image-viewer');
    const ctx = waveformCanvas.getContext('2d');
    const tplSelect = document.getElementById('template-select');
    const tplBtn = document.getElementById('add-template-btn');

    let activeFolderNode = null;
    let activeFileNode = null;
    let isDragging = false;
    let fileBlobs = new Map();

    const rootLi = addNode(tree, 'project', true, true);
    setActiveFolder(rootLi);
    
    if (window.TEMPLATES) {
      for (const key in TEMPLATES) {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = key;
        tplSelect.appendChild(opt);
      }
    }

    tplBtn.addEventListener('click', () => {
      const tplKey = tplSelect.value;
      if (!tplKey || !window.TEMPLATES[tplKey]) {
        alert('テンプレートを選択してください。');
        return;
      }
      if (!activeFolderNode) {
        alert('フォルダを選択してください。');
        return;
      }
      const tpl = window.TEMPLATES[tplKey];
      tpl.files.forEach(file => {
        const li = addNode(activeFolderNode.querySelector('.children'), file.name, false, false);
        li.dataset.content = file.content;
      });
    });

    document.addEventListener('focusin', e => {
      if (e.target.classList.contains('name')) e.target.dataset.prev = e.target.value;
    });
    document.addEventListener('change', e => {
      if (e.target.classList.contains('name')) {
        const input = e.target;
        const parent = input.closest('.children') || tree;
        const vals = [...parent.querySelectorAll(':scope>.node .name')].map(n=>n.value.trim());
        if (vals.filter(v=>v===input.value.trim()).length>1) {
          alert('同じ名前があります。元に戻します。');
          input.value = input.dataset.prev;
        }
      }
    });

    importBtn.addEventListener('click', () => {
      if (!activeFolderNode) { alert('フォルダを選択してください。'); return; }
      fileInput.click();
    });
    fileInput.addEventListener('change', e => {
      for (const file of e.target.files) {
        const ext = file.name.split('.').pop().toLowerCase();
        let li;
        if (isTextExt(ext)) {
          li = addTextFile(activeFolderNode.querySelector('.children'));
          const reader = new FileReader();
          reader.onload = () => li.dataset.content = reader.result;
          reader.readAsText(file, 'UTF-8');
        } else {
          li = addNode(activeFolderNode.querySelector('.children'), file.name, false, false);
          const url = URL.createObjectURL(file);
          fileBlobs.set(li, { url, ext });
        }
      }
      fileInput.value = '';
    });

    saveBtn.addEventListener('click', () => {
      if (!activeFileNode) return;
      const ext = activeFileNode.dataset.ext;
      if (isMediaExt(ext)) {
        const base = filenameInput.value.trim();
        activeFileNode.querySelector('.name').value = base + '.' + ext;
      } else {
        activeFileNode.querySelector('.name').value = filenameInput.value.trim();
        activeFileNode.dataset.content = editor.value;
      }
    });

    downloadBtn.addEventListener('click', () => {
      const zip = new JSZip();
      (function walk(ul, dir) {
        ul.querySelectorAll(':scope>.node').forEach(li => {
          const nm = li.querySelector('.name').value.trim();
          if (li.classList.contains('file')) {
            if (fileBlobs.has(li)) {
              fetch(fileBlobs.get(li).url)
                .then(r => r.blob())
                .then(b => dir.file(nm, b));
            } else {
              dir.file(nm, li.dataset.content || '');
            }
          } else {
            const sub = dir.folder(nm);
            walk(li.querySelector('.children'), sub);
          }
        });
      })(tree, zip);
      setTimeout(() => zip.generateAsync({ type:'blob' }).then(b => saveAs(b,'project.zip')), 500);
    });

    function addNode(parent, name, isFolder, isRoot) {
      const li = document.createElement('li');
      li.classList.add('node', isFolder?'folder':'file');
      if (isRoot) li.classList.add('root');
      const controls = `
        ${isFolder?'<button class="add-folder">📁+</button><button class="add-file">📄+</button>':''}
        ${!isRoot?'<button class="delete">🗑️</button>':''}
      `;
      li.innerHTML = `
        <input class="name" value="${name}" ${isFolder?'':'readonly'} />
        <span class="controls">${controls}</span>
        <ul class="children"></ul>
      `;
      parent.appendChild(li);
      if (isFolder) {
        li.addEventListener('click', e => { e.stopPropagation(); setActiveFolder(li); });
        li.querySelector('.add-folder').addEventListener('click', e => { e.stopPropagation(); addNode(li.querySelector('.children'),'new_folder',true,false); });
        li.querySelector('.add-file').addEventListener('click', e => { e.stopPropagation(); addTextFile(li.querySelector('.children')); });
        Sortable.create(li.querySelector('.children'),{group:'nested',animation:150,fallbackOnBody:true,swapThreshold:0.65});
      }
      const d = li.querySelector('.delete');
      if (d) d.addEventListener('click', e => { e.stopPropagation(); if(confirm('削除しますか？')) { if(activeFolderNode===li) activeFolderNode=null; li.remove(); } });
      if (!isFolder) li.addEventListener('click', e => { e.stopPropagation(); displayFile(li); });
      return li;
    }

    function isTextExt(ext) {
      return ['txt','js','html','css','py','java','md','json'].includes(ext);
    }
    
    function isMediaExt(ext) {
      return ['mp3','wav','ogg','mp4','mov','webm','png','jpg','jpeg','gif'].includes(ext);
    }

    function addTextFile(container) {
      const base='new_file', ext='txt';
      let i=1, name;
      const exists = () => [...container.querySelectorAll(':scope>.node .name')]
        .map(n => n.value).includes(name + '.' + ext);
      do { name = `${base}_${i++}`; } while (exists());
      const li = addNode(container, name + '.' + ext, false, false);
      li.dataset.content = '';
      return li;
    }

    function displayFile(li) {
      activeFileNode = li;
      const full = li.querySelector('.name').value;
      const idx = full.lastIndexOf('.');
      const base = full.slice(0, idx);
      const ext = full.slice(idx+1);
      li.dataset.ext = ext;
      
      filenameInput.value = '';
      extensionLabel.textContent = '';
      filenameInput.disabled = true;
      editor.style.display = 'none'; editor.disabled = true;
      waveformCanvas.style.display = 'none';
      audioPlayer.style.display = 'none';
      videoPlayer.style.display = 'none';
      imageViewer.style.display = 'none';
      saveBtn.disabled = true;
      
      if (isTextExt(ext)) {
        filenameInput.value = full;
        extensionLabel.textContent = '';
        filenameInput.disabled = false;
        editor.value = li.dataset.content || '';
        editor.style.display = 'block';
        editor.disabled = false;
        saveBtn.disabled = false;
      }

      else if (['mp3','wav','ogg'].includes(ext) && fileBlobs.has(li)) {
        filenameInput.value = base;
        extensionLabel.textContent = '.' + ext;
        filenameInput.disabled = false;
        audioPlayer.src = fileBlobs.get(li).url;
        audioPlayer.style.display = 'block';
        drawWaveform(fileBlobs.get(li).url);
        saveBtn.disabled = false;
      }

      else if (['mp4','mov','webm'].includes(ext) && fileBlobs.has(li)) {
        filenameInput.value = base;
        extensionLabel.textContent = '.' + ext;
        filenameInput.disabled = false;
        videoPlayer.src = fileBlobs.get(li).url;
        videoPlayer.style.display = 'block';
        saveBtn.disabled = false;
      }

      else if (['png','jpg','jpeg','gif'].includes(ext) && fileBlobs.has(li)) {
        filenameInput.value = base;
        extensionLabel.textContent = '.' + ext;
        filenameInput.disabled = false;
        imageViewer.src = fileBlobs.get(li).url;
        imageViewer.style.display = 'block';
        saveBtn.disabled = false;
      }
    }

    function drawWaveform(url) {
      waveformCanvas.style.display = 'block';
      fetch(url).then(r => r.arrayBuffer()).then(buf => new AudioContext().decodeAudioData(buf))
        .then(audioBuf => {
          const data = audioBuf.getChannelData(0);
          const step = Math.ceil(data.length / waveformCanvas.width);
          const amp = waveformCanvas.height / 2;
          ctx.clearRect(0,0,waveformCanvas.width,waveformCanvas.height);
          ctx.fillStyle = '#555';
          for (let i = 0; i < waveformCanvas.width; i++) {
            let min = 1, max = -1;
            for (let j = 0; j < step; j++) {
              const v = data[(i*step)+j];
              if (v < min) min = v;
              if (v > max) max = v;
            }
            ctx.fillRect(i, (1+min)*amp, 1, Math.max(1, (max-min)*amp));
          }
        })
        .catch(() => {});
    }

    function setActiveFolder(li) {
      if (activeFolderNode) activeFolderNode.classList.remove('selected-folder');
      activeFolderNode = li;
      li.classList.add('selected-folder');
      activeFileNode = null;
      filenameInput.value = '';
      extensionLabel.textContent = '';
      filenameInput.disabled = true;
      editor.value = '';
      editor.disabled = true;
      editor.style.display = 'none';
      waveformCanvas.style.display = 'none';
      audioPlayer.style.display = 'none';
      videoPlayer.style.display = 'none';
      imageViewer.style.display = 'none';
      saveBtn.disabled = true;
    }

    dragbar.addEventListener('mousedown', () => { isDragging = true; document.body.style.cursor = 'col-resize'; });
    document.addEventListener('mousemove', e => {
      if (!isDragging) return;
      const pct = e.clientX / window.innerWidth * 100;
      if (pct > 10 && pct < 90) {
        leftPanel.style.width = pct + '%';
        rightPanel.style.width = (100 - pct) + '%';
      }
    });
    document.addEventListener('mouseup', () => {
      if (isDragging) { isDragging = false; document.body.style.cursor = ''; }
    });
  </script>
</body>
</html>
